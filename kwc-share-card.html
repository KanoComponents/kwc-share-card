<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../kwc-style/kwc-style.html">
<link rel="import" href="./assets/svgs.html">

<!--
`kwc-share-card`
Display a creation made with Kano Code.

@demo demo/index-card.html
-->

<dom-module id="kwc-share-card">
    <template>
        <style>
            :host *[hidden] {
                display: none !important;
            }
            .wrapper {
                display: block;
                width: 100%;
                font-family: var(--font-body);
            }
            .cover {
                position: relative;
                margin-bottom: 10px;
                width: 100%;
            }
            .cover .avatar {
                position: absolute;
                bottom: -10px;
                left: 16px;
                height: 40px;
                width: 40px;
                border-radius: 100%;
                border: 4px solid white;
                cursor: pointer;
            }
            .cover .staff-picked-badge {
                position: absolute;
                top: 16px;
                right: 16px;
                height: 32px;
                width: 32px;
            }
            .title,
            .username {
                cursor: pointer;
                font-weight: bold;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 100%;
            }
            .username .username-text,
            .title .title-text {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .title {
                font-size: 20px;
                line-height: 21px;
                margin-bottom: 8px;
            }
            .username {
                font-size: 16px;
                line-height: 16px;
                margin-bottom: 8px;
            }
            .username .username-text {
                color: var(--color-grey);
                font-weight: bold;
            }
            iron-image {
                width: 100%;
                height: 100%;
            }
        </style>

        <div class="wrapper">
            <div class="cover">
                <slot name="cover"></slot>
                <iron-image
                    on-tap="_onTapAvatar"
                    src="[[_avatar]]"
                    class="avatar"
                    sizing="cover"
                    preload
                    fade>
                </iron-image>
                <template is="dom-if" if="[[share.featured]]">
                    <iron-image
                        class="staff-picked-badge"
                        sizing="cover"
                        preload
                        fade
                        src$="[[_getEncodedAsset('featured')]]">
                    </iron-image>
                </template>
            </div>
            <div class="title" on-tap="_onTapTitle">
                <!-- If you want to mark this post with an icon (for example animation)
                you can slot it into this `title-icon` slot -->
                <span><slot name="title-icon"></slot></span>
                <span class="title-text">[[share.title]]</span>
            </div>
            <div class="username" on-tap="_onTapUsername">
                <span class="username-text">by [[share.user.username]]</span>
            </div>
            <div id="actions">
                <slot name="actions"></slot>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'kwc-share-card',
            properties: {
                /**
                 * Object retrieved from API representing creation/share
                 * information.
                 * @type {Object}
                 */
                share: {
                    type: Object,
                    value: null
                },
                /**
                 * Image to fallback in case user doesn't have an avatar.
                 * @type {String}
                 */
                defaultAvatar: {
                    type: String,
                    value: () => {
                        return window.Kano.Components.KwcShareCardAssets.assets['defaultAvatar'];
                    }
                },
                /**
                 * Computed source (`src`) data for the avatar to be displayed.
                 * @type {String}
                 */
                _avatar: {
                    type: String,
                    computed: '_computeAvatar(share.user.avatar.urls.circle)'
                }
            },
            listeners: {
                /**
                 * Listens to every event of type `action-tapped` that happens
                 * inside the `actions` slotted
                 */
                'action-tapped': '_onActionTapped'
            },
            /**
             * Handles `action-tapped` events from inside the `actions` slot.
             * It's expected that the `action-tapped` event sends which `action`
             * was tapped as its parameter. This method fires an event named
             * by this `action` (for example: `like`, `remix`, `send-to-kit`)
             * and pass the current share `id` as parameter.
             * @param {Event} e Event object from `action-tapped`.
             */
            _onActionTapped (e) {
                let action = e.detail;
                if (action) {
                    this.fire(action, this.share);
                }
            },
            /**
             * Computes which avatar source (`src`) to be used. If user has
             * an avatar use it, otherwise fallback to the `defaultAvatar`.
             * @param {String} avatar Share's creator avatar.
             * @return {String}
             */
            _computeAvatar (avatar) {
                return avatar ? avatar : this.defaultAvatar;
            },
            /**
             * Fired when avatar is tapped
             *
             * @event avatar-tapped
             * @param {Object} user User who created the tapped avatar.
             */
            /**
             * Handles tap event on the avatar and fires `avatar-tapped`
             * @param {Event} e Event object from tap.
             */
            _onTapAvatar (e) {
                this.fire('avatar-tapped', this.share.user);
            },
            /**
             * Handles tap event on the avatar and fires `avatar-tapped`
             * @param {Event} e Event object from tap.
             */
            _onTapUsername (e) {
                this.fire('username-tapped', this.share.user);
            },
            /**
             * Fired when share title is tapped
             *
             * @event title-tapped
             * @param {Object} share Share tapped.
             */
            /**
             * Handles tap event on the title and fires `title-tapped`
             * @param {Event} e Event object from tap.
             */
            _onTapTitle (e) {
                this.fire('title-tapped', this.share);
            },
            /**
             * Get `svg` data from asset dictionary by key.
             * @param {String} assetName Dictionary key where `svg` data is
             *     stored.
             * @return {String}
             */
            _getEncodedAsset (assetName) {
                return window.Kano.Components.KwcShareCardAssets.assets[assetName];
            }
        });
    </script>
</dom-module>
